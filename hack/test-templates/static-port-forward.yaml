images:
- location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-amd64.img"
  arch: "x86_64"

provision:
- mode: system
  script: |
    apt-get update
    apt-get install -y nginx python3
    systemctl enable nginx
    systemctl start nginx

    cat > /etc/systemd/system/test-server-9080.service << 'EOF'
    [Unit]
    Description=Test Server on Port 9080
    After=network.target

    [Service]
    Type=simple
    User=root
    ExecStart=/usr/bin/python3 -m http.server 9080 --bind 127.0.0.1
    Restart=always

    [Install]
    WantedBy=multi-user.target
    EOF

    cat > /etc/systemd/system/test-server-9070.service << 'EOF'
    [Unit]
    Description=Test Server on Port 9070
    After=network.target

    [Service]
    Type=simple
    User=root
    ExecStart=/usr/bin/python3 -m http.server 9070 --bind 127.0.0.1
    Restart=always

    [Install]
    WantedBy=multi-user.target
    EOF

    mkdir -p /var/www/html-9080
    mkdir -p /var/www/html-9070

    echo '<html><body><h1>Dynamic port 9080</h1></body></html>' > /var/www/html-9080/index.html
    echo '<html><body><h1>Dynamic port 9070</h1></body></html>' > /var/www/html-9070/index.html

    systemctl daemon-reload
    systemctl enable test-server-9080
    systemctl enable test-server-9070
    systemctl start test-server-9080
    systemctl start test-server-9070

portForwards:
- guestPort: 80
  hostPort: 9090
  static: true
- guestPort: 9080
  hostPort: 9080
  static: false
- guestPort: 9070
  hostPort: 9070
  static: false
